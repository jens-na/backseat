#!/usr/bin/env ruby

begin
  require 'backseat'
  require 'getoptlong'
  require 'yaml'
  require 'file'
rescue LoadError
  require 'rubygems'
  require 'backseat'
end

module Backseat

  check = false
  list_cand = false
  cand_name = nil
  file = "/etc/backseat.yml"
  root = "/srv/backseat/"

  opts = GetoptLong.new(
    [ '--help', '-h', GetoptLong::NO_ARGUMENT ],
    [ '--file', '-f', GetoptLong::REQUIRED_ARGUMENT ],
    [ '--candidate', '-c', GetoptLong::REQUIRED_ARGUMENT ],
    [ '--list-candidates', '-l', GetoptLong::NO_ARGUMENT ]
  )

  opts.each do |opt,arg|
    case opt
      when '--help'
        puts <<-EOF
Usage: backseat [OPTIONS]

-f, --file
  an alternaive configuration file of backseat

-c, --candidate
  specifies the candidate to use

-l, --list-candidates
  list the configured candidates

-h, --help
  show help

        EOF
        exit 0
      when '--file'
        file = arg
      when '--candidate'
        cand_name = arg
      when '--list-candidates'
        list_cand = true
    end
  end
  
config = Config.new(file)
begin
  config.check
rescue Exception => e
  puts e
  exit 1
end

cfg = config.cfg

if list_cand
  candidates = cfg['candidates']
 
  candidates.each do |key,value|
    puts key
  end
  exit 0
end

if cand_name != nil
  root = cfg['candidates'][cand_name]['root']
  expire = cfg['candidates'][cand_name]['notifications']['nobackup']['expire']
  cand = Candidate.new(cand_name, root, expire)

  if cand.expired?
    puts "expired"
  else
    puts "not expired!"
  end
end
end
