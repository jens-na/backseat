#!/usr/bin/env ruby

begin
  require 'backseat'
  require 'getoptlong'
  require 'yaml'
  require 'file'
rescue LoadError
  require 'rubygems'
  require 'backseat'
end

module Backseat

  check = false
  cand_name = nil
  file = "/etc/backseat.yml"
  root = "/srv/backseat/"

  opts = GetoptLong.new(
    [ '--help', '-h', GetoptLong::NO_ARGUMENT ],
    [ '--file', '-f', GetoptLong::REQUIRED_ARGUMENT ],
    [ '--candidate', '-c', GetoptLong::REQUIRED_ARGUMENT ]
  )

  opts.each do |opt,arg|
    case opt
      when '--help'
        puts <<-EOF
Usage: backseat [OPTIONS]

-c, --check
  check the backups of all configured backup candidates

-f, --file
  an alternaive configuration file of backseat

-h, --help
  show help

        EOF
        exit 0
      when '--file'
        file = arg
      when '--candidate'
        cand_name = arg
    end
  end
  
config = Config.new(file)
begin
  config.check
rescue Exception => e
  puts e
  exit 1
end

cfg = config.cfg

if cand_name != nil
  root = cfg['candidates'][cand_name]['root']
  expire = cfg['candidates'][cand_name]['notifications']['nobackup']['expire']

  cand = Candidate.new(cand_name, root, expire)

  if cand.expired?
    puts "expired"
  else
    puts "not expired!"
  end
end

end
